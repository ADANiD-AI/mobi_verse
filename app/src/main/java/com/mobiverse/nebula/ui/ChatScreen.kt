package com.mobiverse.nebula.ui\n\nimport androidx.compose.foundation.background\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.foundation.lazy.rememberLazyListState\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.Mic\nimport androidx.compose.material.icons.filled.Stop\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.clip\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.compose.ui.unit.dp\nimport androidx.lifecycle.ViewModel\nimport androidx.lifecycle.ViewModelProvider\nimport androidx.lifecycle.viewmodel.compose.viewModel\nimport com.google.firebase.auth.FirebaseAuth\nimport com.google.firebase.firestore.FirebaseFirestore\nimport com.mobiverse.nebula.audio.AudioPlayer\nimport com.mobiverse.nebula.audio.AudioRecorder\nimport com.mobiverse.nebula.data.AppDatabase\nimport com.mobiverse.nebula.data.MessageRepository\nimport com.mobiverse.nebula.data.entity.SatelliteMessageEntity\nimport com.mobiverse.nebula.satellite.SatelliteMessenger\nimport kotlinx.coroutines.launch\nimport java.text.SimpleDateFormat\nimport java.util.Date\nimport java.util.Locale\n\n@Composable\nfun ChatScreen() {\n    val context = LocalContext.current\n    val db = AppDatabase.getInstance(context)\n    val firestore = FirebaseFirestore.getInstance()\n    val repository = remember { MessageRepository(db.messageDao(), firestore) }\n    val recipientId = \"user_recipient_789\" // Hardcoded for now\n\n    val viewModel: ChatViewModel = viewModel(factory = ChatViewModelFactory(repository, recipientId))\n    val messages by viewModel.messages.collectAsState()\n    \n    val audioRecorder = remember { AudioRecorder(context) }\n    val audioPlayer = remember { AudioPlayer() }\n    val messenger = remember { SatelliteMessenger(context) }\n    val currentUserId = FirebaseAuth.getInstance().currentUser?.uid\n    \n    var isRecording by remember { mutableStateOf(false) }\n    var playingMessageId by remember { mutableStateOf<String?>(null) }\n    \n    val listState = rememberLazyListState()\n    val coroutineScope = rememberCoroutineScope()\n\n    // Scroll to the bottom when new messages arrive\n    LaunchedEffect(messages.size) {\n        if (messages.isNotEmpty()) {\n            coroutineScope.launch {\n                listState.animateScrollToItem(messages.size - 1)\n            }\n        }\n    }\n\n    Scaffold(\n        bottomBar = {\n            MessageInput(isRecording = isRecording) {\n                if (isRecording) {\n                    audioRecorder.stop()?.let { file ->\n                        messenger.sendVoiceMessageAsync(file, recipientId)\n                    }\n                } else {\n                    audioRecorder.start(\"voice_message_${System.currentTimeMillis()}\")\n                }\n                isRecording = !isRecording\n            }\n        }\n    ) {\ padding ->\n        LazyColumn(\n            state = listState,\n            modifier = Modifier.fillMaxSize().padding(padding).padding(horizontal = 8.dp),\n            verticalArrangement = Arrangement.spacedBy(8.dp),\n            contentPadding = PaddingValues(vertical = 8.dp)\n        ) {\n            items(messages) {\n                val isSentByMe = it.senderId == currentUserId\n                MessageBubble(\n                    message = it, \n                    isSentByMe = isSentByMe,\n                    isPlaying = it.id == playingMessageId,\n                    onPlayPause = {\n                        if (playingMessageId == it.id) {\n                            audioPlayer.stop()\n                            playingMessageId = null\n                        } else {\n                            audioPlayer.stop() // Stop any other playback\n                            it.voicePath?.let { path ->\n                                playingMessageId = it.id\n                                audioPlayer.play(path) { playingMessageId = null } // On completion\n                            }\n                        }\n                    }\n                )\n            }\n        }\n    }\n}\n\n@Composable\nfun MessageBubble(\n    message: SatelliteMessageEntity,\n    isSentByMe: Boolean,\n    isPlaying: Boolean,\n    onPlayPause: () -> Unit\n) {\n    val alignment = if (isSentByMe) Alignment.CenterEnd else Alignment.CenterStart\n    val bubbleColor = if (isSentByMe) MaterialTheme.colorScheme.primaryContainer else MaterialTheme.colorScheme.secondaryContainer\n    \n    Box(modifier = Modifier.fillMaxWidth(), contentAlignment = alignment) {\n        Surface(\n            shape = RoundedCornerShape(16.dp),\n            color = bubbleColor,\n            modifier = Modifier.widthIn(max = 300.dp)\n        ) {\n            Column(modifier = Modifier.padding(10.dp)) {\n                Row(verticalAlignment = Alignment.CenterVertically) {\n                    IconButton(onClick = onPlayPause, enabled = message.voicePath != null) {\n                        Icon(if (isPlaying) Icons.Default.Stop else Icons.Default.PlayArrow, contentDescription = \"Play/Pause\")\n                    }\n                    Spacer(modifier = Modifier.width(4.dp))\n                    Text(\"Voice Message\", style = MaterialTheme.typography.bodyLarge)\n                }\n                val formattedTime = remember(message.timestamp) {\n                    SimpleDateFormat(\"hh:mm a\", Locale.getDefault()).format(Date(message.timestamp))\n                }\n                Text(\n                    text = formattedTime,\n                    style = MaterialTheme.typography.bodySmall,\n                    modifier = Modifier.align(Alignment.End)\n                )\n            }\n        }\n    }\n}\n\n@Composable\nfun MessageInput(isRecording: Boolean, onRecordClick: () -> Unit) {\n    Row(\n        modifier = Modifier.fillMaxWidth().padding(8.dp),\n        verticalAlignment = Alignment.CenterVertically,\n        horizontalArrangement = Arrangement.Center\n    ) {\n        FloatingActionButton(\n            onClick = onRecordClick,\n            containerColor = if (isRecording) Color.Red else MaterialTheme.colorScheme.primary,\n            contentColor = Color.White\n        ) {\n            Icon(\n                imageVector = if (isRecording) Icons.Default.Stop else Icons.Default.Mic,\n                contentDescription = \"Record/Stop\"\n            )\n        }\n    }\n}\n\n// A simple factory to create the ViewModel with parameters\n@Suppress(\"UNCHECKED_CAST\")\nclass ChatViewModelFactory(private val repository: MessageRepository, private val recipientId: String) : ViewModelProvider.Factory {\n    override fun <T : ViewModel> create(modelClass: Class<T>): T {\n        if (modelClass.isAssignableFrom(ChatViewModel::class.java)) {\n            return ChatViewModel(repository, recipientId) as T\n        }\n        throw IllegalArgumentException(\"Unknown ViewModel class\")\n    }\n}\n